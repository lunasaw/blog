(window.webpackJsonp=window.webpackJsonp||[]).push([[128],{767:function(a,t,s){"use strict";s.r(t);var e=s(7),r=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h2",{attrs:{id:"haproxy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#haproxy"}},[a._v("#")]),a._v(" HAProxy")]),a._v(" "),s("h2",{attrs:{id:"haproxyä»‹ç»"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#haproxyä»‹ç»"}},[a._v("#")]),a._v(" HAProxyä»‹ç»")]),a._v(" "),s("p",[a._v("HAProxy: æ˜¯æ³•å›½äººWilly Tarreauå¼€å‘çš„ä¸€ä¸ªå¼€æºè½¯ä»¶ï¼Œæ˜¯ä¸€æ¬¾åº”å¯¹å®¢æˆ·ç«¯10000ä»¥ä¸Šçš„åŒæ—¶è¿æ¥çš„é«˜æ€§èƒ½çš„TCPå’Œ HTTPè´Ÿè½½å‡è¡¡å™¨ã€‚å…¶åŠŸèƒ½æ˜¯ç”¨æ¥æä¾›åŸºäºcookieçš„æŒä¹…æ€§ï¼Œ åŸºäºå†…å®¹çš„äº¤æ¢ï¼Œè¿‡è½½ä¿æŠ¤çš„é«˜çº§æµé‡ç®¡åˆ¶ï¼Œè‡ªåŠ¨æ•…éšœåˆ‡æ¢ ï¼Œä»¥æ­£åˆ™è¡¨è¾¾å¼ä¸ºåŸºç¡€çš„æ ‡é¢˜æ§åˆ¶è¿è¡Œæ—¶é—´ï¼ŒåŸºäºWebçš„æŠ¥è¡¨ï¼Œé«˜çº§æ—¥å¿—è®°å½•ä»¥å¸®åŠ©æ’é™¤æ•…â€¹@éšœçš„åº”ç”¨æˆ–ç½‘ç»œåŠå…¶ä»–åŠŸèƒ½ã€‚")]),a._v(" "),s("h2",{attrs:{id:"ç›¸å…³æ¦‚å¿µ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ç›¸å…³æ¦‚å¿µ"}},[a._v("#")]),a._v(" ç›¸å…³æ¦‚å¿µ")]),a._v(" "),s("h3",{attrs:{id:"ä»£ç†çš„ä½œç”¨"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ä»£ç†çš„ä½œç”¨"}},[a._v("#")]),a._v(" ä»£ç†çš„ä½œç”¨")]),a._v(" "),s("ol",[s("li",[a._v("æ­£å‘ä»£ç†ï¼Œåå‘ä»£ç†")]),a._v(" "),s("li",[a._v("ä»£ç†æœåŠ¡å™¨ï¼Œå¯ä»¥æä¾›ç¼“å­˜åŠŸèƒ½åŠ é€Ÿå®¢æˆ·ç«¯è®¿é—®ï¼ŒåŒæ—¶å¯ä»¥å¯¹ç¼“å­˜æ•°æ®è¿›è¡Œæœ‰æ•ˆæ€§æ£€æŸ¥")]),a._v(" "),s("li",[a._v("å†…å®¹è·¯ç”±ï¼šæ ¹æ®æµé‡ä»¥åŠå†…å®¹ç±»å‹å°†è¯·æ±‚è½¬å‘è‡³ç‰¹å®šçš„æœåŠ¡å™¨")]),a._v(" "),s("li",[a._v("è½¬ç å™¨ï¼šæ”¯æŒå‹ç¼©åŠŸèƒ½ï¼Œå°†æ•°æ®ä»¥å‹ç¼©å½¢å¼å‘é€ç»™å®¢æˆ·ç«¯")])]),a._v(" "),s("h3",{attrs:{id:"ç¼“å­˜çš„ä½œç”¨"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ç¼“å­˜çš„ä½œç”¨"}},[a._v("#")]),a._v(" ç¼“å­˜çš„ä½œç”¨")]),a._v(" "),s("ol",[s("li",[a._v("å‡å°‘è®¿å†—ä½™å†…å®¹ä¼ è¾“")]),a._v(" "),s("li",[a._v("èŠ‚çœå¸¦å®½ï¼Œç¼“è§£ç½‘ç»œç“¶é¢ˆ")]),a._v(" "),s("li",[a._v("é™ä½äº†å¯¹åŸå§‹æœåŠ¡å™¨çš„è¯·æ±‚å‹åŠ›")]),a._v(" "),s("li",[a._v("é™ä½äº†ä¼ è¾“å»¶è¿Ÿ")])]),a._v(" "),s("h3",{attrs:{id:"è´Ÿè½½å‡è¡¡é›†ç¾¤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#è´Ÿè½½å‡è¡¡é›†ç¾¤"}},[a._v("#")]),a._v(" è´Ÿè½½å‡è¡¡é›†ç¾¤ï¼š")]),a._v(" "),s("p",[a._v("å››å±‚ï¼š\nlvs, nginx(stream)ï¼Œhaproxy(mode tcp)\nä¸ƒå±‚ï¼š\nhttp: nginx(http, ngx_http_upstream_module), haproxy(mode http), httpd, ats, perlbal, pound...")]),a._v(" "),s("h3",{attrs:{id:"haproxyåŠŸèƒ½"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#haproxyåŠŸèƒ½"}},[a._v("#")]),a._v(" HAProxyåŠŸèƒ½")]),a._v(" "),s("p",[a._v("HAProxyæ˜¯TCP / HTTPåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå°¤å…¶é€‚åˆäºé«˜å¯ç”¨æ€§ç¯å¢ƒ\nå¯ä»¥é’ˆå¯¹HTTPè¯·æ±‚æ·»åŠ cookieï¼Œè¿›è¡Œè·¯ç”±åç«¯æœåŠ¡å™¨\nå¯å¹³è¡¡è´Ÿè½½è‡³åç«¯æœåŠ¡å™¨ï¼Œå¹¶æ”¯æŒæŒä¹…è¿æ¥\næ”¯æŒåŸºäºcookieè¿›è¡Œè°ƒåº¦\næ”¯æŒæ‰€æœ‰ä¸»æœåŠ¡å™¨æ•…éšœåˆ‡æ¢è‡³å¤‡ç”¨æœåŠ¡å™¨\næ”¯æŒä¸“ç”¨ç«¯å£å®ç°ç›‘æ§æœåŠ¡\næ”¯æŒä¸å½±å“ç°æœ‰è¿æ¥æƒ…å†µä¸‹åœæ­¢æ¥å—æ–°è¿æ¥è¯·æ±‚\nå¯ä»¥åœ¨åŒå‘æ·»åŠ ï¼Œä¿®æ”¹æˆ–åˆ é™¤HTTPæŠ¥æ–‡é¦–éƒ¨\næ”¯æŒåŸºäºpatternå®ç°è¿æ¥è¯·æ±‚çš„è®¿é—®æ§åˆ¶\né€šè¿‡ç‰¹å®šçš„URIä¸ºæˆæƒç”¨æˆ·æä¾›è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯\nç‰ˆæœ¬ï¼š1.4 1.5 1.6 1.7 1.8\n"),s("img",{attrs:{src:"https://i.loli.net/2021/01/29/xjDWm63snTL48fG.png",alt:"img"}})]),a._v(" "),s("p",[a._v("æ”¯æŒhttpåå‘ä»£ç†\næ”¯æŒåŠ¨æ€ç¨‹åºçš„åå‘ä»£ç†\næ”¯æŒåŸºäºæ•°æ®åº“çš„åå‘ä»£ç†")]),a._v(" "),s("h2",{attrs:{id:"haproxyç»„æˆ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#haproxyç»„æˆ"}},[a._v("#")]),a._v(" HAproxyç»„æˆ")]),a._v(" "),s("p",[a._v("åŒ…åï¼šhaproxy")]),a._v(" "),s("h3",{attrs:{id:"ç¨‹åºç¯å¢ƒ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ç¨‹åºç¯å¢ƒ"}},[a._v("#")]),a._v(" ç¨‹åºç¯å¢ƒ")]),a._v(" "),s("p",[a._v("ä¸»ç¨‹åºï¼š/usr/sbin/haproxy\né…ç½®æ–‡ä»¶ï¼š/etc/haproxy/haproxy.cfg\nUnit fileï¼š/usr/lib/systemd/system/haproxy.service")]),a._v(" "),s("h3",{attrs:{id:"é…ç½®æ–‡ä»¶"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#é…ç½®æ–‡ä»¶"}},[a._v("#")]),a._v(" é…ç½®æ–‡ä»¶")]),a._v(" "),s("p",[a._v("haproxy.cfgä¸»è¦æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼šglobalï¼Œå’Œproxiesé…ç½®æ®µ")]),a._v(" "),s("h4",{attrs:{id:"global-å…¨å±€é…ç½®æ®µ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#global-å…¨å±€é…ç½®æ®µ"}},[a._v("#")]),a._v(" globalï¼šå…¨å±€é…ç½®æ®µ")]),a._v(" "),s("p",[a._v("è¿›ç¨‹åŠå®‰å…¨é…ç½®ç›¸å…³çš„å‚æ•°\næ€§èƒ½è°ƒæ•´ç›¸å…³å‚æ•°\nDebugå‚æ•°")]),a._v(" "),s("h4",{attrs:{id:"proxies-ä»£ç†é…ç½®æ®µ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#proxies-ä»£ç†é…ç½®æ®µ"}},[a._v("#")]),a._v(" proxiesï¼šä»£ç†é…ç½®æ®µ")]),a._v(" "),s("p",[a._v("defaultsï¼šä¸ºfrontend, backend, listenæä¾›é»˜è®¤é…ç½®\nfrontedï¼šå‰ç«¯ï¼Œç›¸å½“äºnginx, server {}\nbackendï¼šåç«¯ï¼Œç›¸å½“äºnginx, upstream {}\nlistenï¼šåŒæ—¶æ‹¥æœ‰å‰ç«¯å’Œåç«¯,é€‚ç”¨äºä¸€å¯¹ä¸€ç¯å¢ƒ")]),a._v(" "),s("h3",{attrs:{id:"ç®€å•å‰ç«¯è°ƒåº¦å®ç°"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ç®€å•å‰ç«¯è°ƒåº¦å®ç°"}},[a._v("#")]),a._v(" ç®€å•å‰ç«¯è°ƒåº¦å®ç°")]),a._v(" "),s("p",[a._v("åˆ©ç”¨å››å°è™šæ‹Ÿæœºå®ç°ç®€å•çš„å‰ç«¯è½®è¯¢è°ƒåº¦ã€‚\nä¸€å°å®¢æˆ·ç«¯ï¼Œä¸€å°haproxyè°ƒåº¦å™¨ï¼Œä¸¤å°RS")]),a._v(" "),s("ol",[s("li",[s("p",[a._v("é¦–å…ˆåœ¨åç«¯éƒ¨ç½²ä¸¤å°httpæœåŠ¡")])]),a._v(" "),s("li",[s("p",[a._v("ç¼–è¾‘haproxyé…ç½®æ–‡ä»¶/etc/haproxy/haproxy.cfg\né»˜è®¤è®¾ç½®ä¸åšä¿®æ”¹")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@CentOS6 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# vim /etc/haproxy/haproxy.cfg ")]),a._v("\nfrontend  main *:80     "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#è®¾ç½®ç›‘å¬ipï¼šç«¯å£")]),a._v("\ndefault_backend         websrvs     "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#è°ƒç”¨åç«¯RSç»„å")]),a._v("\nbackend websrvs\nbalance     roundrobin      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#è½®è¯¢ç®—æ³•")]),a._v("\nserver      web1 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".45.11:80 check\nserver      web2 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".45.12:80 check\n")])])])])]),a._v(" "),s("h2",{attrs:{id:"é…ç½®"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#é…ç½®"}},[a._v("#")]),a._v(" é…ç½®")]),a._v(" "),s("h3",{attrs:{id:"globalé…ç½®å‚æ•°"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#globalé…ç½®å‚æ•°"}},[a._v("#")]),a._v(" globalé…ç½®å‚æ•°ï¼š")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("global      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# å…¨å±€å‚æ•°çš„è®¾ç½®")]),a._v("\nlog         "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),a._v(".0.1   local2                      \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# logè¯­æ³•ï¼šlog <address_1>[max_level_1] ")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# å…¨å±€çš„æ—¥å¿—é…ç½®ï¼Œä½¿ç”¨logå…³é”®å­—ï¼ŒæŒ‡å®šä½¿ç”¨127.0.0.1ä¸Šçš„syslogæœåŠ¡ä¸­çš„local0æ—¥å¿—è®¾å¤‡ï¼Œè®°å½•æ—¥å¿—ç­‰çº§ä¸ºinfoçš„æ—¥å¿—")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chroot")]),a._v("      /var/lib/haproxy        "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æ”¹å˜å½“å‰å·¥ä½œç›®å½•")]),a._v("\npidfile     /var/run/haproxy.pid    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å½“å‰è¿›ç¨‹idæ–‡ä»¶")]),a._v("\nmaxconn     "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4000")]),a._v("                    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æœ€å¤§è¿æ¥æ•°")]),a._v("\nuser        haproxy                 "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æ‰€å±ç”¨æˆ·")]),a._v("\ngroup       haproxy                 "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æ‰€å±ç»„")]),a._v("\ndaemon                              "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œhaproxy")]),a._v("\nstats socket /var/lib/haproxy/stats "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#åŸºäºæœ¬åœ°çš„æ–‡ä»¶ä¼ è¾“")]),a._v("\n")])])]),s("p",[a._v("å®ç°æ—¥å¿—è®°å½•ï¼š\nhaproxyé…ç½®æ–‡ä»¶ä¸­é»˜è®¤å®šä¹‰äº†log 127.0.0.1 local2 è¯´æ˜æ—¥å¿—å°†è¢«è®°å½•åœ¨æœ¬æœºçš„local2è®¾æ–½ä¸­ã€‚\nç¼–è¾‘rsyslogé…ç½®æ–‡ä»¶ï¼š")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@CentOS6 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#vim /etc/rsyslog.conf")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Provides UDP syslog reception")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$ModLoad")]),a._v(" imudp      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å–æ¶ˆæ³¨é‡Š")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$UDPServerRun")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("514")]),a._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å–æ¶ˆæ³¨é‡Š")]),a._v("\nlocal2.*            /var/log/haproxy.log\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æŒ‡å®šè®¾å¤‡local2æ—¥å¿—å­˜æ”¾ä½ç½®")]),a._v("\n")])])]),s("p",[a._v("haproxyçš„æ—¥å¿—ä¿¡æ¯å¯ä»¥è®¾ç½®å­˜æ”¾åœ¨ä¸“é—¨çš„æ—¥å¿—æœåŠ¡å™¨ä¸­")]),a._v(" "),s("h3",{attrs:{id:"proxiesé…ç½®å‚æ•°"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#proxiesé…ç½®å‚æ•°"}},[a._v("#")]),a._v(" proxiesé…ç½®å‚æ•°ï¼š")]),a._v(" "),s("p",[a._v("ä»£ç†é…ç½®æ®µï¼š")]),a._v(" "),s("ul",[s("li",[a._v("defaults "),s("name")],1),a._v(" "),s("li",[a._v("frontend "),s("name")],1),a._v(" "),s("li",[a._v("backend "),s("name")],1),a._v(" "),s("li",[a._v("listen "),s("name")],1)]),a._v(" "),s("p",[a._v("Frontendæ®µï¼šæŒ‡å®šæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ä¾¦å¬å¥—æ¥å­—è®¾ç½®\nBackendæ®µï¼šæŒ‡å®šå°†è¿æ¥è¯·æ±‚è½¬å‘è‡³åç«¯æœåŠ¡å™¨çš„ç›¸å…³è®¾ç½®\nListenæ®µï¼šæŒ‡å®šå®Œæ•´çš„å‰åç«¯è®¾ç½®ï¼Œåªå¯¹ TCP æœ‰æ•ˆ\nproxy åç§°ï¼šä½¿ç”¨å­—æ¯ æ•°å­— - _ . : å¹¶åŒºåˆ†å­—ç¬¦å¤§å°å†™")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("mode        http             \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#é»˜è®¤çš„æ¨¡å¼mode { tcp|http|health }ï¼Œtcpæ˜¯4å±‚ï¼Œhttpæ˜¯7å±‚ï¼Œhealthåªä¼šè¿”å›OK")]),a._v("\nlog         global        \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#åº”ç”¨å…¨å±€çš„æ—¥å¿—é…ç½®")]),a._v("\noption      httplog       \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# å¯ç”¨æ—¥å¿—è®°å½•HTTPè¯·æ±‚ï¼Œé»˜è®¤haproxyæ—¥å¿—è®°å½•æ˜¯ä¸è®°å½•HTTPè¯·æ±‚æ—¥å¿—")]),a._v("\noption      dontlognull   \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# å¯ç”¨è¯¥é¡¹ï¼Œæ—¥å¿—ä¸­å°†ä¸ä¼šè®°å½•ç©ºè¿æ¥ã€‚æ‰€è°“ç©ºè¿æ¥å°±æ˜¯åœ¨ä¸Šæ¸¸çš„è´Ÿè½½å‡è¡¡å™¨æˆ–è€…ç›‘æ§ç³»ç»Ÿä¸ºäº†æ¢æµ‹è¯¥æœåŠ¡æ˜¯å¦å­˜æ´»å¯ç”¨æ—¶ï¼Œéœ€è¦å®šæœŸçš„è¿æ¥æˆ–è€…è·å–æŸä¸€å›ºå®šçš„ç»„ä»¶æˆ–é¡µé¢ï¼Œæˆ–è€…æ¢æµ‹æ‰«æç«¯å£æ˜¯å¦åœ¨ç›‘å¬æˆ–å¼€æ”¾ç­‰åŠ¨ä½œè¢«ç§°ä¸ºç©ºè¿æ¥ï¼›å®˜æ–¹æ–‡æ¡£ä¸­æ ‡æ³¨ï¼Œå¦‚æœè¯¥æœåŠ¡ä¸Šæ¸¸æ²¡æœ‰å…¶ä»–çš„è´Ÿè½½å‡è¡¡å™¨çš„è¯ï¼Œå»ºè®®ä¸è¦ä½¿ç”¨è¯¥å‚æ•°ï¼Œå› ä¸ºäº’è”ç½‘ä¸Šçš„æ¶æ„æ‰«ææˆ–å…¶ä»–åŠ¨ä½œå°±ä¸ä¼šè¢«è®°å½•ä¸‹æ¥")]),a._v("\noption      http-server-close  \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æ¯æ¬¡è¯·æ±‚å®Œæ¯•åä¸»åŠ¨å…³é—­httpé€šé“")]),a._v("\noption      forwardfor       except "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),a._v(".0.0/8   \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v('#å¦‚æœæœåŠ¡å™¨ä¸Šçš„åº”ç”¨ç¨‹åºæƒ³è®°å½•å‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯çš„IPåœ°å€ï¼Œéœ€è¦åœ¨HAProxyä¸Šé…ç½®æ­¤é€‰é¡¹ï¼Œ è¿™æ · HAProxyä¼šæŠŠå®¢æˆ·ç«¯çš„IPä¿¡æ¯å‘é€ç»™æœåŠ¡å™¨ï¼Œåœ¨HTTPè¯·æ±‚ä¸­æ·»åŠ "X-Forwarded-For"å­—æ®µã€‚å¯ç”¨X-Forwarded-Forï¼Œåœ¨requestså¤´éƒ¨æ’å…¥å®¢æˆ·ç«¯IPå‘é€ç»™åç«¯çš„serverï¼Œä½¿åç«¯serverè·å–åˆ°å®¢æˆ·ç«¯çš„çœŸå®IPã€‚ ')]),a._v("\noption        redispatch                      \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å½“ä½¿ç”¨äº†cookieæ—¶ï¼Œhaproxyå°†ä¼šå°†å…¶è¯·æ±‚çš„åç«¯æœåŠ¡å™¨çš„serverIDæ’å…¥åˆ°cookieä¸­ï¼Œä»¥ä¿è¯ä¼šè¯çš„SESSIONæŒä¹…æ€§ï¼›è€Œæ­¤æ—¶ï¼Œå¦‚æœåç«¯çš„æœåŠ¡å™¨å®•æ‰äº†ï¼Œ ä½†æ˜¯å®¢æˆ·ç«¯çš„cookieæ˜¯ä¸ä¼šåˆ·æ–°çš„ï¼Œå¦‚æœè®¾ç½®æ­¤å‚æ•°ï¼Œå°†ä¼šå°†å®¢æˆ·çš„è¯·æ±‚å¼ºåˆ¶å®šå‘åˆ°å¦å¤–ä¸€ä¸ªåç«¯serverä¸Šï¼Œä»¥ä¿è¯æœåŠ¡çš„æ­£å¸¸ã€‚")]),a._v("\nretries       "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v("                             \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# å®šä¹‰è¿æ¥åç«¯æœåŠ¡å™¨çš„å¤±è´¥é‡è¿æ¬¡æ•°ï¼Œè¿æ¥å¤±è´¥æ¬¡æ•°è¶…è¿‡æ­¤å€¼åå°†ä¼šå°†å¯¹åº”åç«¯æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("timeout")]),a._v(" http-request    10s     "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#httpè¯·æ±‚è¶…æ—¶æ—¶é—´")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("timeout")]),a._v(" queue           1m      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#ä¸€ä¸ªè¯·æ±‚åœ¨é˜Ÿåˆ—é‡Œçš„è¶…æ—¶æ—¶é—´")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("timeout")]),a._v(" connect         10s     "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#è¿æ¥è¶…æ—¶")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("timeout")]),a._v(" client          1m      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å®¢æˆ·ç«¯è¶…æ—¶")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("timeout")]),a._v(" server          1m      "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æœåŠ¡å™¨ç«¯è¶…æ—¶")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("timeout")]),a._v(" http-keep-alive 10s     "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#è®¾ç½®http-keep-aliveçš„è¶…æ—¶æ—¶é—´")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("timeout")]),a._v(" check           10s     "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æ£€æµ‹è¶…æ—¶")]),a._v("\nmaxconn                 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3000")]),a._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æ¯ä¸ªè¿›ç¨‹å¯ç”¨çš„æœ€å¤§è¿æ¥æ•°")]),a._v("\nfrontend  main *:80             "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#ç›‘å¬åœ°å€ä¸º80")]),a._v("\nacl url_static       path_beg       -i /static /images /javascript /stylesheets\nacl url_static       path_end       -i .jpg .gif .png .css .js\nuse_backend static          "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" url_static\ndefault_backend             my_webserver     \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å®šä¹‰ä¸€ä¸ªåä¸ºmy_appå‰ç«¯éƒ¨åˆ†ã€‚æ­¤å¤„å°†å¯¹åº”çš„è¯·æ±‚è½¬å‘ç»™åç«¯")]),a._v("\nbackend static                                       \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#ä½¿ç”¨äº†é™æ€åŠ¨æ€åˆ†ç¦»ï¼ˆå¦‚æœurl_pathåŒ¹é… .jpg .gif .png .css .jsé™æ€æ–‡ä»¶åˆ™è®¿é—®æ­¤åç«¯ï¼‰")]),a._v("\nbalance             roundrobin                       \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆ#banlance roundrobin è½®è¯¢ï¼Œbalance source ä¿å­˜sessionå€¼ï¼Œæ”¯æŒstatic-rrï¼Œleastconnï¼Œfirstï¼Œuriç­‰å‚æ•°ï¼‰")]),a._v("\nserver              static "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),a._v(".0.1:80 check         \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#é™æ€æ–‡ä»¶éƒ¨ç½²åœ¨æœ¬æœºï¼ˆä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨å…¶ä»–æœºå™¨æˆ–è€…squidç¼“å­˜æœåŠ¡å™¨ï¼‰")]),a._v("\nbackend my_webserver                                 \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å®šä¹‰ä¸€ä¸ªåä¸ºmy_webserveråç«¯éƒ¨åˆ†ã€‚PSï¼šæ­¤å¤„my_webserveråªæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰åå­—è€Œå·²ï¼Œä½†æ˜¯éœ€è¦ä¸frontendé‡Œé¢é…ç½®é¡¹default_backend å€¼ç›¸ä¸€è‡´")]),a._v("\nbalance     roundrobin          "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#è´Ÿè½½å‡è¡¡ç®—æ³•")]),a._v("\nserver  web01 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.31")]),a._v(".2.33:80  check inter "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2000")]),a._v(" fall "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" weight "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("30")]),a._v("              "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å®šä¹‰çš„å¤šä¸ªåç«¯")]),a._v("\nserver  web02 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.31")]),a._v(".2.34:80  check inter "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2000")]),a._v(" fall "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" weight "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("30")]),a._v("              "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å®šä¹‰çš„å¤šä¸ªåç«¯")]),a._v("\nserver  web03 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.31")]),a._v(".2.35:80  check inter "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2000")]),a._v(" fall "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" weight "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("30")]),a._v("              "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å®šä¹‰çš„å¤šä¸ªåç«¯")]),a._v("\n")])])]),s("h3",{attrs:{id:"balanceé…ç½®"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#balanceé…ç½®"}},[a._v("#")]),a._v(" Balanceé…ç½®")]),a._v(" "),s("p",[a._v("balanceï¼šåç«¯æœåŠ¡å™¨ç»„å†…çš„æœåŠ¡å™¨è°ƒåº¦ç®—æ³•\nbalance "),s("algorithm",[a._v(" [ "),s("arguments",[a._v(" ]\nbalance url_param "),s("param"),a._v(" [check_post]\nhaproxyä¸­è°ƒåº¦ç®—æ³•åŒæ ·åˆ†ä¸ºåŠ¨æ€è°ƒåº¦ç®—æ³•å’Œé™æ€è°ƒåº¦ç®—æ³•ï¼Œä¸nginxè°ƒåº¦ç®—æ³•ä¸­åŒºåˆ†åŠ¨é™æ€è°ƒåº¦ç®—æ³•çš„æ¦‚å¿µä¸åŒï¼Œnginxç”¨èƒ½ä¸èƒ½æ ¹æ®åç«¯æœåŠ¡å™¨çš„è´Ÿè½½çŠ¶å†µè¿›è¡Œè°ƒåº¦æ¥åŒºåˆ†åŠ¨é™æ€è°ƒåº¦ç®—æ³•çš„å·®åˆ«ï¼Œè€Œhaproxyä¸­åˆ™æ ¹æ®è¯¥ç®—æ³•æ”¯ä¸æ”¯æŒè¿è¡Œæ—¶å³æ—¶ç”Ÿæ•ˆæ¥åŒºåˆ†åŠ¨é™æ€ç®—æ³•ã€‚")])],1)],1),a._v(" "),s("p",[a._v("è°ƒåº¦ç®—æ³•ï¼š\nroundrobinï¼šåŸºäºæƒé‡è½®è¯¢ï¼ŒåŠ¨æ€ç®—æ³•ï¼Œæ”¯æŒæƒé‡çš„è¿è¡Œæ—¶è°ƒæ•´ï¼Œæ”¯æŒæ…¢å¯åŠ¨ï¼›æ¯ä¸ªåç«¯backendä¸­æœ€å¤šæ”¯æŒ4095ä¸ª\nserver server optionsï¼š weight #")]),a._v(" "),s("p",[a._v("static-rrï¼šåŸºäºæƒé‡è½®è¯¢ï¼Œé™æ€ç®—æ³•ï¼Œä¸æ”¯æŒæƒé‡çš„è¿è¡Œæ—¶è°ƒæ•´åŠæ…¢å¯åŠ¨ï¼›åç«¯ä¸»æœºæ•°é‡æ— ä¸Šé™")]),a._v(" "),s("p",[a._v("leastconnï¼šåŠ æƒæœ€å°‘è¿æ¥ï¼ŒåŠ¨æ€ç®—æ³•ï¼Œæœ€å°‘è¿æ¥çš„åç«¯æœåŠ¡å™¨ä¼˜å…ˆåˆ†é…æ¥æ”¶æ–°è¿æ¥ï¼Œç›¸åŒè¿æ¥æ—¶è½®è¯¢ï¼Œé€‚ç”¨äºé•¿è¿æ¥åœºæ™¯ï¼Œä¾‹å¦‚ MySQLã€LDAPç­‰ï¼Œä¸é€‚åˆhttp")]),a._v(" "),s("p",[a._v("firstï¼šæ ¹æ®æœåŠ¡å™¨åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®ï¼Œè‡ªä¸Šè€Œä¸‹è¿›è¡Œè°ƒåº¦ï¼›å‰é¢æœåŠ¡å™¨çš„è¿æ¥æ•°è¾¾åˆ°ä¸Šé™ï¼Œæ–°è¯·æ±‚æ‰ä¼šåˆ†é…ç»™ä¸‹ä¸€å°æœåŠ¡")]),a._v(" "),s("p",[a._v("sourceï¼šæºåœ°å€hashï¼Œæ–°è¿æ¥å…ˆæŒ‰æƒé‡åˆ†é…ï¼Œåç»­è¿æ¥æŒ‰sourceåˆ†é…è¯·æ±‚\nåŠ¨é™æ€å–å†³äºhash type\nhash-typeï¼šå“ˆå¸Œç®—æ³•\nhash-type "),s("method",[s("function",[s("modifier",[a._v("\nmethod:\nmap-basedï¼šé™¤æƒå–ä½™æ³•ï¼Œå“ˆå¸Œæ•°æ®ç»“æ„æ˜¯é™æ€æ•°ç»„ï¼ˆä¸æ”¯æŒæƒé‡åŠ¨æ€è°ƒæ•´ï¼‰\nconsistentï¼šä¸€è‡´æ€§å“ˆå¸Œï¼Œå“ˆå¸Œæ•°æ®ç»“æ„æ˜¯ä¸€æ£µæ ‘ ï¼ˆæ”¯æŒæƒé‡åŠ¨æ€è°ƒæ•´ï¼‰\n"),s("function",[a._v(" : å“ˆå¸Œå‡½æ•°\nsdbm djb2 wt6")])],1)],1)],1)],1),a._v(" "),s("p",[a._v("uriï¼š\nå¯¹URIçš„å·¦åŠéƒ¨åˆ†æˆ–æ•´ä¸ªuriåšhashè®¡ç®—ï¼Œå¹¶é™¤ä»¥æœåŠ¡å™¨æ€»æƒé‡å–æ¨¡ï¼Œä»¥åæ´¾å‘è‡³æŸæŒ‘å‡ºçš„æœåŠ¡å™¨,é€‚ç”¨äºåç«¯ç¼“å­˜æœåŠ¡å™¨\nåŠ¨é™æ€å–å†³äºhash type")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("hash-type\n    map-based\n    consistent\n")])])]),s("p",[s("scheme",[a._v("ğŸ˜•/"),s("user",[a._v(":"),s("password",[a._v("@"),s("host",[a._v(":"),s("port",[a._v("/"),s("path",[a._v(" ;"),s("params",[a._v("?"),s("query",[a._v("#"),s("frag",[a._v("\nå·¦åŠéƒ¨åˆ†ï¼š/"),s("path",[a._v(";"),s("params",[a._v("\næ•´ä¸ªuriï¼š/"),s("path",[a._v(";"),s("params",[a._v("?"),s("query",[a._v("#"),s("frag")],1)],1)],1)])],1)])],1)],1)],1)])],1)],1)],1)],1)],1),a._v(" "),s("p",[a._v("url_paramï¼š\nå¯¹ç”¨æˆ·è¯·æ±‚çš„uriå¬"),s("params",[a._v("éƒ¨åˆ†ä¸­çš„å‚æ•°çš„å€¼ä½œhashè®¡ç®—ï¼Œ å¹¶ç”±æœåŠ¡å™¨æ€»æƒé‡ç›¸é™¤ä»¥åæ´¾å‘è‡³æŸæŒ‘å‡ºçš„æœåŠ¡å™¨ï¼›é€šå¸¸ç”¨äºè¿½è¸ªç”¨æˆ·ï¼Œä»¥ç¡®ä¿æ¥è‡ªåŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚å§‹ç»ˆå‘å¾€åŒä¸€ä¸ªBackend Server\nåŠ¨é™æ€å–å†³äºhash type")])],1),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("hash-type\n    map-based\n    consistent\n")])])]),s("p",[a._v("hdr("),s("name",[a._v(")ï¼šæ ¹æ®è¯·æ±‚æŠ¥æ–‡ä¸­æŒ‡å®šçš„headerï¼ˆå¦‚use_agent,referer,hostnameï¼‰å°†è¯¥hesderåšhashè®¡ç®—è¿›è¡Œè°ƒåº¦\nåŠ¨é™æ€å–å†³äºhash type")])],1),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("hash-type\n    map-based\n    consistent\n")])])]),s("p",[a._v("hdr(Cookie)")]),a._v(" "),s("p",[a._v("rdp-cookie è¿œç¨‹æ¡Œé¢ç›¸å…³")]),a._v(" "),s("p",[a._v("rdp-cookie("),s("name",[a._v(")")])],1),a._v(" "),s("h3",{attrs:{id:"default-backend"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#default-backend"}},[a._v("#")]),a._v(" default_backend "),s("backend")],1),a._v(" "),s("p",[a._v("æ— use_backend åŒ¹é…æ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„backendï¼Œç”¨äº frontendä¸­")]),a._v(" "),s("h3",{attrs:{id:"server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#server"}},[a._v("#")]),a._v(" server")]),a._v(" "),s("p",[a._v("server "),s("name",[s("address",[a._v("[:[port]] [param*]\nå®šä¹‰åç«¯ä¸»æœºçš„å„æœåŠ¡å™¨åŠå…¶é€‰é¡¹ server "),s("name",[s("address",[a._v("[:port] [settings ...] default-server [settings ...]")])])],1)])],1),a._v(" "),s("p",[s("name",[a._v("ï¼šæœåŠ¡å™¨åœ¨haproxyä¸Šçš„å†…éƒ¨åç§°ï¼›å‡ºç°åœ¨æ—¥å¿—åŠè­¦å‘Šä¿¡æ¯")])],1),a._v(" "),s("address",[a._v("ï¼šæœåŠ¡å™¨åœ°å€ï¼Œæ”¯æŒä½¿ç”¨ä¸»æœºå\n"),s("p",[a._v("[:[port]]ï¼šç«¯å£æ˜ å°„ï¼›çœç•¥æ—¶ï¼Œè¡¨ç¤ºåŒbindä¸­ç»‘å®šçš„ç«¯å£")]),a._v(" "),s("p",[a._v("[param*]ï¼šå‚æ•°\ncheckï¼šå¯¹å½“å‰serveråšå¥åº·çŠ¶æ€æ£€æµ‹ï¼Œåªç”¨äºå››å±‚æ£€æµ‹\næ³¨æ„ï¼šhttpchkï¼Œâ€œsmtpchkâ€, â€œmysql-checkâ€, â€œpgsql-checkâ€ and â€œsslhello-chkâ€ ç”¨äºå®šä¹‰åº”ç”¨å±‚æ£€æµ‹æ–¹æ³•\naddr ï¼šæ£€æµ‹æ—¶ä½¿ç”¨çš„IPåœ°å€\nport ï¼šé’ˆå¯¹æ­¤ç«¯å£è¿›è¡Œæ£€æµ‹\ninter "),s("delay",[a._v("ï¼šè¿ç»­ä¸¤æ¬¡æ£€æµ‹ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º2000ms\nrise "),s("count",[a._v("ï¼šè¿ç»­å¤šå°‘æ¬¡æ£€æµ‹ç»“æœä¸ºâ€œæˆåŠŸâ€æ‰æ ‡è®°æœåŠ¡å™¨ä¸ºå¯ç”¨ ï¼›é»˜è®¤ä¸º2\nfall "),s("count",[a._v("ï¼šè¿ç»­å¤šå°‘æ¬¡æ£€æµ‹ç»“æœä¸ºâ€œå¤±è´¥â€æ‰æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¯ ç”¨ï¼›é»˜è®¤ä¸º3\ncookie "),s("value",[a._v("ï¼šä¸ºå½“å‰serveræŒ‡å®šcookieå€¼ï¼Œå®ç°åŸºäºcookieçš„ä¼šè¯é»æ€§\ndisabledï¼šæ ‡è®°ä¸ºä¸å¯ç”¨\nredir "),s("prefix",[a._v("ï¼šå°†å‘å¾€æ­¤serverçš„æ‰€æœ‰GETå’ŒHEADç±»çš„è¯·æ±‚é‡å®šå‘è‡³æŒ‡ å®šçš„URL\nweight "),s("weight",[a._v("ï¼šæƒé‡ï¼Œé»˜è®¤ä¸º1\nmaxconn "),s("maxconn",[a._v("ï¼šå½“å‰serverçš„æœ€å¤§å¹¶å‘è¿æ¥æ•°\nbacklog "),s("backlog",[a._v("ï¼šå½“serverçš„è¿æ¥æ•°è¾¾åˆ°ä¸Šé™åçš„åæ´é˜Ÿåˆ—é•¿åº¦\nbackupï¼šè®¾å®šå½“å‰serverä¸ºå¤‡ç”¨æœåŠ¡å™¨")])],1)],1)],1)],1)],1)],1)],1)],1),a._v(" "),s("p",[a._v("default-server [param*] ä¸ºbackendä¸­çš„å„serverè®¾å®šé»˜è®¤é€‰é¡¹")]),a._v(" "),s("h3",{attrs:{id:"bindé…ç½®"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#bindé…ç½®"}},[a._v("#")]),a._v(" bindé…ç½®")]),a._v(" "),s("p",[a._v("bindï¼šæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå‰ç«¯ä¾¦å¬åœ°å€å’Œç«¯å£\nåªç”¨äºfrountendé…ç½®æ®µå’Œlistené…ç½®æ®µ\nbind [")]),s("address",[a._v("]:<port_range> [, ...] [param*]\nç¤ºä¾‹ï¼š"),s("p"),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("listen http_proxy \n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("bind")]),a._v(" :80,:443 \n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("bind")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10.0")]),a._v(".0.1:10080,10.0.0.1:10443 \n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("bind")]),a._v(" /var/run/ssl-frontend.sock user root mode "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("600")]),a._v(" accept-proxy\n")])])]),s("h3",{attrs:{id:"maxconn"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#maxconn"}},[a._v("#")]),a._v(" maxconn")]),a._v(" "),s("p",[a._v("maxconn "),s("conns",[a._v("ï¼šä¸ºæŒ‡å®šçš„frontendå®šä¹‰å…¶æœ€å¤§å¹¶å‘è¿æ¥æ•°ï¼›é»˜è®¤ä¸º2000")])],1),a._v(" "),s("h3",{attrs:{id:"mode-tcp-http-health"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mode-tcp-http-health"}},[a._v("#")]),a._v(" mode { tcp|http|health }")]),a._v(" "),s("p",[a._v("å®šä¹‰haproxyçš„å·¥ä½œæ¨¡å¼\ntcpï¼šåŸºäºlayer4å®ç°ä»£ç†ï¼›å¯ä»£ç†mysql, pgsql, ssh, sslç­‰åè®®,httpsæ—¶ä½¿ç”¨æ­¤æ¨¡å¼ï¼Œé»˜è®¤æ¨¡å¼\nhttpï¼šä»…å½“ä»£ç†åè®®ä¸ºhttpæ—¶ä½¿ç”¨,centoså®é™…é»˜è®¤æ¨¡å¼\nhealthï¼šå·¥ä½œä¸ºå¥åº·çŠ¶æ€æ£€æŸ¥çš„å“åº”æ¨¡å¼ï¼Œå½“è¿æ¥è¯·æ±‚åˆ°è¾¾æ—¶å›åº”â€œOKâ€åå³æ–­å¼€è¿æ¥ï¼Œè¾ƒå°‘ä½¿ç”¨")]),a._v(" "),s("h3",{attrs:{id:"åŸºäºcookieçš„ä¼šè¯ç»‘å®š"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#åŸºäºcookieçš„ä¼šè¯ç»‘å®š"}},[a._v("#")]),a._v(" åŸºäºcookieçš„ä¼šè¯ç»‘å®š")]),a._v(" "),s("p",[a._v("cookie "),s("name",[a._v(" [ rewrite | insert | prefix ] [ indirect ] [ nocache ] [ postonly ] [ preserve ] [ httponly ] [ secure ] [ domain "),s("domain",[a._v(" ]* [ maxidle "),s("idle",[a._v(" ] [ maxlife "),s("life",[a._v(" ]\n"),s("name",[a._v("ï¼šcookieåç§°ï¼Œç”¨äºå®ç°æŒä¹…è¿æ¥\nrewriteï¼šé‡å†™\ninsertï¼šæ’å…¥\nprefixï¼šå‰ç¼€\né…ç½®ç¤ºä¾‹ï¼š")])],1)],1)],1)],1)],1),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("backend websrvs\n  balance     roundrobin\n  cookie WEBSRV insert nocache indirect\n  server   web1 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".45.11:80 check cookie srv1\n  server   web2 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".45.12:80 check cookie srv2\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æ¯ä¸ªserveræœ‰è‡ªå·±çš„å”¯ä¸€çš„cookieæ ‡è¯†")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#åœ¨backendä¸­ä¸ºç”¨æˆ·è¯·æ±‚è°ƒåº¦å®Œæˆåæ“çºµå…¶cookie")]),a._v("\n")])])]),s("h3",{attrs:{id:"ç»Ÿè®¡æ¥å£å¯ç”¨ç›¸å…³çš„å‚æ•°"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ç»Ÿè®¡æ¥å£å¯ç”¨ç›¸å…³çš„å‚æ•°"}},[a._v("#")]),a._v(" ç»Ÿè®¡æ¥å£å¯ç”¨ç›¸å…³çš„å‚æ•°")]),a._v(" "),s("p",[a._v("stats enable\nå¯ç”¨ç»Ÿè®¡é¡µï¼›åŸºäºé»˜è®¤çš„å‚æ•°å¯ç”¨stats page")]),a._v(" "),s("ul",[s("li",[a._v("stats uri : /haproxy?stats urié»˜è®¤å€¼")]),a._v(" "),s("li",[a._v("stats realm : HAProxy Statistics")]),a._v(" "),s("li",[a._v("stats auth : no authentication")])]),a._v(" "),s("p",[a._v("stats uri "),s("prefix",[a._v(" è‡ªå®šä¹‰stats page uri")])],1),a._v(" "),s("p",[a._v("stats auth "),s("user",[a._v(":"),s("passwd",[a._v(" è®¤è¯æ—¶çš„è´¦å·å’Œå¯†ç ï¼Œå¯ä½¿ç”¨å¤šæ¬¡")])],1)],1),a._v(" "),s("p",[a._v("stats realm "),s("realm",[a._v(" è®¤è¯æ—¶çš„realm")])],1),a._v(" "),s("p",[a._v("stats hide-version éšè—ç‰ˆæœ¬")]),a._v(" "),s("p",[a._v("stats refresh "),s("delay",[a._v(" è®¾å®šè‡ªåŠ¨åˆ·æ–°æ—¶é—´é—´éš”")])],1),a._v(" "),s("p",[a._v("stats admin { if | unless } "),s("cond",[a._v(" å¯ç”¨stats pageä¸­çš„ç®¡ç†åŠŸèƒ½")])],1),a._v(" "),s("p",[a._v("é…ç½®ç¤ºä¾‹ï¼š")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("listen stats \n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("bind")]),a._v(" :9099 \n    stats "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v(" \n    stats realm HAPorxy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v(" Stats"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v(" Page \n    stats auth ç”¨æˆ·åï¼šå¯†ç \n    stats admin "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" TRUE\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#åœ¨frountendä¸­å•ç‹¬å®šä¹‰ä¸€ä¸ªstatsæœåŠ¡ï¼Œç›‘å¬9099ç«¯å£")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#å¦‚æœè®¤è¯æˆåŠŸå°±å¼€å¯ç®¡ç†åŠŸèƒ½")]),a._v("\n")])])]),s("h3",{attrs:{id:"forwardforé…ç½®"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#forwardforé…ç½®"}},[a._v("#")]),a._v(" forwardforé…ç½®")]),a._v(" "),s("p",[a._v("option forwardfor [ except "),s("network",[a._v(" ] [ header "),s("name",[a._v(" ] [ if-none ]\nåœ¨ç”±haproxyå‘å¾€åç«¯ä¸»æœºçš„è¯·æ±‚æŠ¥æ–‡ä¸­æ·»åŠ â€œX-ForwardedForâ€é¦–éƒ¨ï¼Œå…¶å€¼ä¸ºå‰ç«¯å®¢æˆ·ç«¯çš„åœ°å€ï¼›ç”¨äºå‘åç«¯ä¸»å‘é€çœŸå®çš„å®¢æˆ·ç«¯IP")])],1)],1),a._v(" "),s("p",[a._v("[ except "),s("network",[a._v(" ]ï¼šè¯·æ±‚æŠ¥è¯·æ¥è‡ªæ­¤å¤„æŒ‡å®šçš„ç½‘ç»œæ—¶ä¸äºˆæ·»åŠ æ­¤é¦–éƒ¨ï¼Œå¦‚haproxyè‡ªèº«æ‰€åœ¨ç½‘ç»œ")])],1),a._v(" "),s("p",[a._v("[ header "),s("name",[a._v(" ]ï¼šä½¿ç”¨è‡ªå®šä¹‰çš„é¦–éƒ¨åç§°ï¼Œè€Œéâ€œXForwarded-Forâ€")])],1),a._v(" "),s("p",[a._v("[ if-none ] å¦‚æœæ²¡æœ‰é¦–éƒ¨æ‰æ·»åŠ é¦–éƒ¨ï¼Œå¦‚æœæœ‰ä½¿ç”¨é»˜è®¤å€¼")]),a._v(" "),s("p",[a._v("ä¸ºæŒ‡å®šçš„MIMEç±»å‹å¯ç”¨å‹ç¼©ä¼ è¾“åŠŸèƒ½\ncompression algo "),s("algorithm",[a._v(" ...ï¼šå¯ç”¨httpåè®®çš„å‹ç¼©æœºåˆ¶ï¼ŒæŒ‡æ˜å‹ç¼©ç®—æ³•gzip, deflate\ncompression type "),s("mime",{attrs:{type:""}},[a._v(" ...ï¼šæŒ‡æ˜å‹ç¼©çš„MIMIç±»å‹")])],1)],1),a._v(" "),s("h3",{attrs:{id:"é”™è¯¯é¡µé…ç½®"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#é”™è¯¯é¡µé…ç½®"}},[a._v("#")]),a._v(" é”™è¯¯é¡µé…ç½®")]),a._v(" "),s("p",[a._v("errorfile "),s("code",[s("file",[a._v(" è‡ªå®šä¹‰é”™è¯¯é¡µ\n"),s("code",[a._v("ï¼šHTTP status code.\næ”¯æŒ200, 400, 403, 408, 500, 502, 503, 504.\n"),s("file",[a._v("ï¼šé”™è¯¯é¡µæ–‡ä»¶è·¯å¾„")])],1)])],1)]),a._v(" "),s("p",[a._v("ç¤ºä¾‹ï¼š\nä½¿ç”¨haproxyä¸»æœºæœ¬åœ°çš„æ–‡ä»¶è¿›è¡Œå“åº”")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("errorfile "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("400")]),a._v(" /etc/haproxy/errorfiles/400badreq.http \nerrorfile "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("408")]),a._v(" /dev/null     "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# workaround Chrome preconnect bug ")]),a._v("\nerrorfile "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("403")]),a._v(" /etc/haproxy/errorfiles/403forbid.http \nerrorfile "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("503")]),a._v(" /etc/haproxy/errorfiles/503sorry.http \n")])])]),s("p",[a._v("ä½¿ç”¨urlè¿›è¡Œå“åº”ï¼Œå“åº”çŠ¶æ€ç ä¸º302ï¼Œä¸é€‚ç”¨äºGETä»¥å¤–çš„å…¶ä»–è¯·æ±‚æ–¹æ³•ï¼š\nerrorloc "),s("code",[s("url",[a._v(" ç›¸å½“äºerrorloc302 "),s("code",[s("url",[a._v("ï¼Œåˆ©ç”¨302é‡å®šå‘è‡³æŒ‡URL")])],1)])],1)]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("errorloc 503 http://www.a.com/error_pages/503.html\n")])])]),s("h3",{attrs:{id:"ä¿®æ”¹æŠ¥æ–‡é¦–éƒ¨"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ä¿®æ”¹æŠ¥æ–‡é¦–éƒ¨"}},[a._v("#")]),a._v(" ä¿®æ”¹æŠ¥æ–‡é¦–éƒ¨")]),a._v(" "),s("p",[a._v("reqadd "),s("string",[a._v(" [{if | unless} "),s("cond",[a._v("]\nåœ¨è¯·æ±‚æŠ¥æ–‡å°¾éƒ¨æ·»åŠ æŒ‡å®šé¦–éƒ¨")])],1)],1),a._v(" "),s("p",[a._v("rspadd "),s("string",[a._v(" [{if | unless} "),s("cond",[a._v("]\nåœ¨å“åº”æŠ¥æ–‡å°¾éƒ¨æ·»åŠ æŒ‡å®šé¦–éƒ¨\nç¤ºä¾‹ï¼š")])],1)],1),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("rspadd X-Via:\\ HAPorxy  #å­—ç¬¦ä¸²ä¸­çš„ç©ºæ ¼è¦è½¬ä¹‰\n")])])]),s("p",[a._v("reqdel "),s("search",[a._v(" [{if | unless} "),s("cond",[a._v("]\nreqidel "),s("search",[a._v(" [{if | unless} "),s("cond",[a._v("] (ignore case) ä¸åˆ†å¤§å°å†™\nä»è¯·æ±‚æŠ¥æ–‡ä¸­åˆ é™¤åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„é¦–éƒ¨")])],1)],1)],1)],1),a._v(" "),s("p",[a._v("rspdel "),s("search",[a._v(" [{if | unless} "),s("cond",[a._v("]\nrspidel "),s("search",[a._v(" [{if | unless} "),s("cond",[a._v("] (ignore case) ä¸åˆ†å¤§å°å†™ä»å“åº”æŠ¥æ–‡ä¸­åˆ é™¤åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„é¦–éƒ¨ ç¤ºä¾‹ï¼š rspidel Server.*")])],1)],1)],1)],1),a._v(" "),s("h3",{attrs:{id:"è¿æ¥è¶…æ—¶"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#è¿æ¥è¶…æ—¶"}},[a._v("#")]),a._v(" è¿æ¥è¶…æ—¶")]),a._v(" "),s("p",[a._v("timeout client "),s("timeout",[a._v(" å®¢æˆ·ç«¯æœ€é•¿ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é•¿ é»˜è®¤å•ä½æ˜¯æ¯«ç§’\ntimeout server "),s("timeout",[a._v(" åç«¯æœåŠ¡å™¨æœ€é•¿ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é•¿\ntimeout http-keep-alive "),s("timeout",[a._v(" æŒä¹…è¿æ¥çš„æŒä¹…æ—¶é•¿\ntimeout http-request "),s("timeout",[a._v(" ä¸€æ¬¡å®Œæ•´çš„HTTPè¯·æ±‚çš„æœ€å¤§ç­‰å¾…æ—¶é•¿\ntimeout connect "),s("timeout",[a._v(" æˆåŠŸè¿æ¥åç«¯æœåŠ¡å™¨çš„æœ€å¤§ç­‰å¾…æ—¶é•¿\ntimeout client-fin "),s("timeout",[a._v(" å®¢æˆ·ç«¯åŠè¿æ¥çš„ç©ºé—²æ—¶é•¿\ntimeout server-fin "),s("timeout",[a._v(" åç«¯æœåŠ¡å™¨åŠè¿æ¥çš„ç©ºé—²æ—¶é•¿")])],1)],1)],1)],1)],1)],1)],1),a._v(" "),s("h2",{attrs:{id:"acl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#acl"}},[a._v("#")]),a._v(" ACL")]),a._v(" "),s("p",[a._v("aclï¼šhaproxyçš„ACLç”¨äºå®ç°åŸºäºè¯·æ±‚æŠ¥æ–‡çš„é¦–éƒ¨ã€å“åº”æŠ¥æ–‡çš„å†…å®¹æˆ–å…¶ä»–çš„ç¯å¢ƒçŠ¶æ€ä¿¡æ¯æ¥åšå‡ºè½¬å‘å†³ç­–ï¼Œè¿™å¤§å¤§å¢åŠ äº†å…¶é…ç½®å¼¹æ€§ã€‚å…¶é…ç½®æ³•åˆ™ä¸€èˆ¬åˆ†ä¸ºä¸¤éƒ¨ï¼Œé¦–å…ˆå®šä¹‰ACLï¼Œæ—¢å®šä¹‰ä¸€ä¸ªæµ‹è¯•æ¡ä»¶ï¼Œè€Œååœ¨æ¡ä»¶å¾—åˆ°æ»¡è¶³æ—¶æ‰§è¡ŒæŸç‰¹å®šåŠ¨ä½œï¼Œå¦‚é˜»æ­¢è®¿é—®æˆ–è€…è½¬å‘è‡³æŸç‰¹å®šçš„åç«¯ï¼Œ\nå®šä¹‰ACLçš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š\nacl "),s("aclname",[s("criterion",[a._v(" [flags] [operator] ["),s("value",[a._v("] ...")])],1)],1)],1),a._v(" "),s("p",[s("aclname",[a._v("ï¼šACLåç§°ï¼Œå¯ä½¿ç”¨å­—æ¯ æ•°å­— : . - _ åŒºåˆ†å­—ç¬¦å¤§å°å†™")])],1),a._v(" "),s("p",[s("criterion",[a._v("ï¼š æŒ‡æ˜æ£€æŸ¥æ¡ä»¶\nå„ç§æ¡ä»¶ :\ndst ç›®æ ‡IP\ndst_port ç›®æ ‡PORT\nsrc æºIP\nsrc_port æºPORT\nç¤ºä¾‹ï¼š")])],1),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("acl invalid_src src 172.16.100.200\n")])])]),s("p",[s("value",[a._v("çš„ç±»å‹ï¼š")])],1),a._v(" "),s("ul",[s("li",[a._v("boolean")]),a._v(" "),s("li",[a._v("integer or integer range")]),a._v(" "),s("li",[a._v("IP address / network")]),a._v(" "),s("li",[a._v("string (exact, substring, suffix, prefix, subdir, domain)")]),a._v(" "),s("li",[a._v("regular expression")]),a._v(" "),s("li",[a._v("hex block")])]),a._v(" "),s("flags",[a._v("\n-i ä¸åŒºåˆ†å¤§å°å†™\n-m ä½¿ç”¨æŒ‡å®šçš„patternåŒ¹é…æ–¹æ³•\n-n ä¸åšDNSè§£æ\n-u å¼ºåˆ¶æ¯ä¸ªACLå¿…é¡»å”¯ä¸€IDï¼Œå¦åˆ™å¤šä¸ªåŒåACLæˆ–å…³ç³»\n-- å¼ºåˆ¶flagç»“æŸ. å½“å­—ç¬¦ä¸²å’ŒæŸä¸ªflagç›¸ä¼¼æ—¶ä½¿ç”¨\n"),s("p",[a._v("[operator]\nåŒ¹é…æ•´æ•°å€¼ï¼šeqã€geã€gtã€leã€lt\nåŒ¹é…å­—ç¬¦ä¸²ï¼š")]),a._v(" "),s("ul",[s("li",[a._v("exact match (-m str) :å­—ç¬¦ä¸²å¿…é¡»å®Œå…¨åŒ¹é…æ¨¡å¼")]),a._v(" "),s("li",[a._v("substring match (-m sub) :åœ¨æå–çš„å­—ç¬¦ä¸²ä¸­æŸ¥æ‰¾æ¨¡å¼ï¼Œ å¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªè¢«å‘ç°ï¼ŒACLå°†åŒ¹é…")]),a._v(" "),s("li",[a._v("prefix match (-m beg) :åœ¨æå–çš„å­—ç¬¦ä¸²é¦–éƒ¨ä¸­æŸ¥æ‰¾æ¨¡å¼ ï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªè¢«å‘ç°ï¼ŒACLå°†åŒ¹é…")]),a._v(" "),s("li",[a._v("suffix match (-m end) :å°†æ¨¡å¼ä¸æå–å­—ç¬¦ä¸²çš„å°¾éƒ¨è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªåŒ¹é…ï¼Œåˆ™ACLè¿›è¡ŒåŒ¹é…")]),a._v(" "),s("li",[a._v("subdir match (-m dir) :æŸ¥çœ‹æå–å‡ºæ¥çš„ç”¨æ–œçº¿åˆ†éš”ï¼ˆ â€œ/â€ï¼‰çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªåŒ¹é…ï¼Œåˆ™ACLè¿›è¡ŒåŒ¹é…")]),a._v(" "),s("li",[a._v("domain match (-m dom) :æŸ¥æ‰¾æå–çš„ç”¨ç‚¹ï¼ˆâ€œ.â€ï¼‰åˆ†éš” å­—ç¬¦ä¸²ï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªåŒ¹é…ï¼Œåˆ™ACLè¿›è¡ŒåŒ¹é…")])]),a._v(" "),s("h3",{attrs:{id:"aclä½œä¸ºæ¡ä»¶æ—¶çš„é€»è¾‘å…³ç³»"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aclä½œä¸ºæ¡ä»¶æ—¶çš„é€»è¾‘å…³ç³»"}},[a._v("#")]),a._v(" aclä½œä¸ºæ¡ä»¶æ—¶çš„é€»è¾‘å…³ç³»:")]),a._v(" "),s("ul",[s("li",[a._v("ä¸ï¼šéšå¼ï¼ˆé»˜è®¤ï¼‰ä½¿ç”¨")]),a._v(" "),s("li",[a._v("æˆ–ï¼šä½¿ç”¨â€œorâ€ æˆ– â€œ||â€è¡¨ç¤º")]),a._v(" "),s("li",[a._v("å¦å®šï¼šä½¿ç”¨â€œ!â€œ è¡¨ç¤º")])]),a._v(" "),s("p",[a._v("ç¤ºä¾‹ï¼š")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" invalid_src invalid_port ä¸å…³ç³» \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" invalid_src "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("||")]),a._v(" invalid_port æˆ– \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" invalid_src é \n")])])]),s("h3",{attrs:{id:"base-string"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#base-string"}},[a._v("#")]),a._v(" base : string")]),a._v(" "),s("p",[a._v("è¿”å›ç¬¬ä¸€ä¸ªä¸»æœºå¤´å’Œè¯·æ±‚çš„è·¯å¾„éƒ¨åˆ†çš„è¿æ¥ï¼Œè¯¥è¯·æ±‚ä»ç¬¬ä¸€ä¸ªæ–œæ å¼€å§‹ï¼Œå¹¶åœ¨é—®å·ä¹‹å‰ç»“æŸ,å¯¹è™šæ‹Ÿä¸»æœºæœ‰ç”¨\n"),s("scheme",[a._v("ğŸ˜•/"),s("user",[a._v(":"),s("password",[a._v("@"),s("host",[a._v(":"),s("port",[a._v("/"),s("path",[a._v(";< params>?"),s("query",[a._v("#"),s("frag",[a._v("\nbase : exact string match\nbase_beg : prefix match\nbase_dir : subdir match\nbase_dom : domain match\nbase_end : suffix match\nbase_len : length match\nbase_reg : regex match\nbase_sub : substring match")])],1)],1)])],1)],1)],1)],1)],1),a._v(" "),s("h3",{attrs:{id:"path-string"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#path-string"}},[a._v("#")]),a._v(" path : string")]),a._v(" "),s("p",[a._v("æå–è¯·æ±‚çš„URLè·¯å¾„ï¼Œè¯¥è·¯å¾„ä»ç¬¬ä¸€ä¸ªæ–œæ å¼€å§‹ï¼Œå¹¶åœ¨é—®å·ä¹‹ å‰ç»“æŸï¼ˆæ— ä¸»æœºéƒ¨åˆ†ï¼‰\n"),s("scheme",[a._v("ğŸ˜•/"),s("user",[a._v(":"),s("password",[a._v("@"),s("host",[a._v(":"),s("port",[a._v("/"),s("path",[a._v(";< params>?"),s("query",[a._v("#"),s("frag",[a._v("\npath : exact string match\npath_beg : prefix match åŒ¹é…è·¯å¾„å¼€å¤´\npath_dir : subdir match\npath_dom : domain match\npath_end : suffix match åŒ¹é…è·¯å¾„ç»“å°¾\npath_len : length match\npath_reg : regex match æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä¸€ç±»PATH\npath_sub : substring match")])],1)],1)])],1)],1)],1)],1)],1),a._v(" "),s("h3",{attrs:{id:"url-string"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#url-string"}},[a._v("#")]),a._v(" url : string")]),a._v(" "),s("p",[a._v("æå–è¯·æ±‚ä¸­çš„URLã€‚ä¸€ä¸ªå…¸å‹çš„åº”ç”¨æ˜¯å…·æœ‰é¢„å–èƒ½åŠ›çš„ç¼“å­˜ï¼Œ ä»¥åŠéœ€è¦ä»æ•°æ®åº“èšåˆå¤šä¸ªä¿¡æ¯å¹¶å°†å®ƒä»¬ä¿å­˜åœ¨ç¼“å­˜ä¸­çš„ç½‘é¡µé—¨æˆ·å…¥å£\nurl : exact string match\nurl_beg : prefix match URLå¼€å¤´ï¼ŒåŒ¹é…åè®®\nurl_dir : subdir match\nurl_dom : domain match\nurl_end : suffix match URLç»“å°¾\nurl_len : length match\nurl_reg : regex match æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä¸€ç±»url\nurl_sub : substring match")]),a._v(" "),s("h3",{attrs:{id:"req-hdr"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#req-hdr"}},[a._v("#")]),a._v(" req.hdr([")]),a._v(" "),s("p",[a._v("æå–åœ¨ä¸€ä¸ªHTTPè¯·æ±‚æŠ¥æ–‡çš„é¦–éƒ¨\nhdr(["),s("name",[a._v("[,"),s("occ",[a._v("]]) : exact string match\nhdr_beg(["),s("name",[a._v("[,"),s("occ",[a._v("]]) : prefix match é¦–éƒ¨å¼€å¤´\nhdr_dir(["),s("name",[a._v("[,"),s("occ",[a._v("]]) : subdir match\nhdr_dom(["),s("name",[a._v("[,"),s("occ",[a._v("]]) : domain match\nhdr_end(["),s("name",[a._v("[,"),s("occ",[a._v("]]) : suffix match é¦–éƒ¨ç»“å°¾\nhdr_len(["),s("name",[a._v("[,"),s("occ",[a._v("]]) : length match\nhdr_reg(["),s("name",[a._v("[,"),s("occ",[a._v("]]) : regex match\nhdr_sub(["),s("name",[a._v("[,"),s("occ",[a._v("]]) : substring match\nç¤ºä¾‹ï¼š")])],1)],1)],1)],1)],1)],1)],1)],1)],1)],1)],1)],1)],1)],1)],1)],1),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("acl bad_curl hdr_sub"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("User-Agent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" -i "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" \nblock "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" bad_curl \n")])])]),s("h3",{attrs:{id:"status-integer"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#status-integer"}},[a._v("#")]),a._v(" status : integer")]),a._v(" "),s("p",[a._v("è¿”å›åœ¨å“åº”æŠ¥æ–‡ä¸­çš„çŠ¶æ€ç ")]),a._v(" "),s("h3",{attrs:{id:"é¢„å®šä¹‰acl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#é¢„å®šä¹‰acl"}},[a._v("#")]),a._v(" é¢„å®šä¹‰ACL")]),a._v(" "),s("p",[a._v("ACLåç§° ç­‰ä»·äº è¯´æ˜\nTRUE always_true æ€»æ˜¯åŒ¹é…\nFALSE always_false ä»ä¸åŒ¹é…\nHTTP req_proto_http åŒ¹é…HTTPåè®®\nHTTP_1.0 req_ver 1.0 åŒ¹é…HTTPåè®®1.0\nHTTP_1.1 req_ver 1.1 åŒ¹é…HTTPåè®®1.1\nHTTP_CONTENT hdr_val(content-length) gt 0 åŒ¹é…å·²å­˜åœ¨å†…å®¹é•¿åº¦\nHTTP_URL_ABS url_reg ^[^/:]"),s("em",[a._v('ğŸ˜•/ åŒ¹é…URLç»å¯¹è·¯å¾„\nHTTP_URL_SLASHurl_beg / åŒ¹é…URLç›¸å¯¹è·¯å¾„\nHTTP_URL_STAR url * åŒ¹é… URL ç­‰äº "')]),a._v('"\nLOCALHOST src 127.0.0.1/8 åŒ¹é…ä»localhostæ¥çš„è¿æ¥\nMETH_CONNECT method CONNECT åŒ¹é…HTTP CONNECTæ–¹æ³•\nMETH_GETmethod GET HEAD #match HTTP GET or HEAD method\nMETH_HEAD method HEAD #match HTTP HEAD method\nMETH_OPTIONS method OPTIONS #match HTTP OPTIONS method\nMETH_POST method POST #match HTTP POST method\nMETH_TRACE method TRACE #match HTTP TRACE method\nRDP_COOKIE req_rdp_cookie_cnt gt 0 #match presence of an RDP cookie\nREQ_CONTENT req_len gt 0 #match data in the request buffer\nWAIT_ENDwait_end #wait for end of content analysis')]),a._v(" "),s("h3",{attrs:{id:"aclé…ç½®"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aclé…ç½®"}},[a._v("#")]),a._v(" aclé…ç½®")]),a._v(" "),s("h4",{attrs:{id:"åŸºäºipçš„è®¿é—®æ§åˆ¶"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#åŸºäºipçš„è®¿é—®æ§åˆ¶"}},[a._v("#")]),a._v(" åŸºäºIPçš„è®¿é—®æ§åˆ¶")]),a._v(" "),s("p",[a._v("use_backend "),s("backend",[a._v(" [{if | unless} "),s("condition",[a._v("]\nå½“if/unlessä¸€ä¸ªåŸºäºACLçš„æ¡ä»¶åŒ¹é…æ—¶åˆ‡æ¢æŒ‡å®šbackend")])],1)],1),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("acl invalid_src src "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".200.2 \nblock "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" invalid_src \nerrorfile "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("403")]),a._v(" /etc/fstab\n")])])]),s("h4",{attrs:{id:"ä¸ƒå±‚è¯·æ±‚çš„è®¿é—®æ§åˆ¶"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ä¸ƒå±‚è¯·æ±‚çš„è®¿é—®æ§åˆ¶"}},[a._v("#")]),a._v(" ä¸ƒå±‚è¯·æ±‚çš„è®¿é—®æ§åˆ¶")]),a._v(" "),s("p",[a._v("http-request { allow | deny |add-header "),s("name",[s("fmt",[a._v(" |set-header "),s("name",[s("fmt",[a._v(" } [ { if | unless } "),s("condition",[a._v(" ]")])],1)],1)],1)],1)],1),a._v(" "),s("h4",{attrs:{id:"å››å±‚è¯·æ±‚è®¿é—®æ§åˆ¶"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å››å±‚è¯·æ±‚è®¿é—®æ§åˆ¶"}},[a._v("#")]),a._v(" å››å±‚è¯·æ±‚è®¿é—®æ§åˆ¶")]),a._v(" "),s("p",[a._v("tcp-request connection {accept|reject} [{if | unless} "),s("condition",[a._v("]\nç¤ºä¾‹ï¼š")])],1),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("listen "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ssh")]),a._v(" \n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("bind")]),a._v(" :22022 \nbalance leastconn \nacl invalid_src src "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".200.2 \ntcp-request connection reject "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" invalid_src \nmode tcp \nserver sshsrv1 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".100.6:22 check \nserver sshsrv2 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".100.7:22 check backup\n")])])]),s("h4",{attrs:{id:"åŸºäºaclçš„åŠ¨é™åˆ†ç¦»ç¤ºä¾‹"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#åŸºäºaclçš„åŠ¨é™åˆ†ç¦»ç¤ºä¾‹"}},[a._v("#")]),a._v(" åŸºäºACLçš„åŠ¨é™åˆ†ç¦»ç¤ºä¾‹")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("frontend  web *:80 \n    acl url_static       path_beg       -i /static /images /javascript /stylesheets \n    acl url_static       path_end       -i .jpg .gif .png .css .js .html .txt .htm \n    use_backend staticsrvs       "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" url_static \n    default_backend             appsrvs \nbackend staticsrvs \n    balance     roundrobin \n    server      stcsrv1 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".100.6:80 check \nbackend appsrvs \n    balance     roundrobin \n    server  app1 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".100.7:80 check \n    server  app1 "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".100.7:8080 check \nlisten stats \n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("bind")]),a._v(" :9091 \n    stats "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v(" \n    stats auth admin:admin \n    stats admin "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" TRUE\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#ä¸€ä¸ªACLå®šä¹‰äº†ä¸¤ä¸ªæ¡ä»¶ï¼Œå¦‚æœç”¨æˆ·çš„è¯·æ±‚æ»¡è¶³PATHä¸­å¸¦æœ‰/static /images /javascript /stylesheets è¿™äº›å­—ç¬¦çš„ï¼Œæˆ–è€…pathæ˜¯ä»¥.jpg .gif .png .css .js .html .txt .htm è¿™äº›å­—ç¬¦ç»“å°¾çš„å°±åŒ¹é…ACLå®šä¹‰")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#æ»¡è¶³ACLå®šä¹‰çš„è¯·æ±‚ä¸ºé™æ€è¯·æ±‚ï¼Œè¢«è°ƒåº¦åˆ°åç«¯çš„staticsrvsæœºç»„ä¸Š")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#ä¸æ»¡ç»„ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„è¯·æ±‚é»˜è®¤è°ƒåº¦éƒ½åç«¯åŒ…å«ä¸¤å°æœåŠ¡å™¨è½®è¯¢çš„appsrvsæœºç»„ä¸Š")]),a._v("\n")])])]),s("h3",{attrs:{id:"æ”¯æŒhttpsåè®®"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#æ”¯æŒhttpsåè®®"}},[a._v("#")]),a._v(" æ”¯æŒhttpsåè®®")]),a._v(" "),s("p",[a._v("é…ç½®HAProxyæ”¯æŒhttpsåè®®ï¼š\n1 æ”¯æŒsslä¼šè¯ï¼›\nbind *:443 ssl crt /PATH/TO/SOME_PEM_FILE\ncrt åè¯ä¹¦æ–‡ä»¶ä¸ºPEMæ ¼å¼ï¼Œä¸”åŒæ—¶åŒ…å«è¯ä¹¦å’Œæ‰€æœ‰ç§é’¥\ncat demo.crt demo.key > demo.pem")]),a._v(" "),s("p",[a._v("2 æŠŠ80ç«¯å£çš„è¯·æ±‚é‡å‘å®š443\nbind *:80\nredirect scheme https if !{ ssl_fc }")]),a._v(" "),s("p",[a._v("3 å‘åç«¯ä¼ é€’ç”¨æˆ·è¯·æ±‚çš„åè®®å’Œç«¯å£ï¼ˆfrontendæˆ–backendï¼‰\nhttp_request set-header X-Forwarded-Port %[dst_port]\nhttp_request add-header X-Forwared-Proto https if { ssl_fc }")])])],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);